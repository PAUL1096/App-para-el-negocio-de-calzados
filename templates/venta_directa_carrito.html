{% extends "base.html" %}
{% block title %}Nueva Venta Directa - Sistema Calzado{% endblock %}
{% block content %}
<div class="page-header">
    <h1><i class="bi bi-cart-plus"></i> Nueva Venta Directa (Multi-Producto)</h1>
    <p class="text-muted">Agregar múltiples productos a la venta</p>
</div>

<div class="row">
    <div class="col-md-8">
        <!-- Selección de Ubicación -->
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="mb-0">1. Seleccionar Ubicación</h5>
            </div>
            <div class="card-body">
                <select class="form-select form-select-lg" id="ubicacion" onchange="cargarInventario()">
                    <option value="">-- Seleccionar Ubicación --</option>
                    {% for ub in ubicaciones %}
                    <option value="{{ ub.id_ubicacion }}">{{ ub.nombre }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <!-- Inventario Disponible -->
        <div class="card mb-3" id="card-inventario" style="display: none;">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">2. Agregar Productos</h5>
                <span id="total-items" class="badge bg-secondary">0 productos disponibles</span>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive" style="max-height: 400px;">
                    <table class="table table-hover mb-0">
                        <thead class="sticky-top bg-light">
                            <tr>
                                <th>Código</th>
                                <th>Producto</th>
                                <th>Stock</th>
                                <th>Precio</th>
                                <th>Acción</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-inventario">
                            <!-- Se carga dinámicamente -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <!-- Carrito de Compras -->
        <div class="card sticky-top" style="top: 20px;">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-cart3"></i> Carrito de Venta</h5>
            </div>
            <div class="card-body">
                <form id="formVenta">
                    <!-- Cliente -->
                    <div class="mb-3">
                        <label class="form-label">Cliente <span class="text-danger">*</span></label>
                        <select class="form-select" id="id_cliente" name="id_cliente" required onchange="seleccionarCliente()">
                            <option value="">-- Seleccionar Cliente --</option>
                            {% for cliente in clientes %}
                            <option value="{{ cliente.id_cliente }}"
                                    data-nombre="{{ cliente.nombre }} {{ cliente.apellido or '' }}">
                                {{ cliente.nombre }} {{ cliente.apellido or '' }}
                                {% if cliente.nombre_comercial %}({{ cliente.nombre_comercial }}){% endif %}
                            </option>
                            {% endfor %}
                        </select>
                        <input type="hidden" id="cliente_nombre" name="cliente">
                    </div>

                    <hr>

                    <!-- Lista de Productos en el Carrito -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">Productos en el Carrito:</label>
                        <div id="lista-carrito" class="mb-2">
                            <p class="text-muted small text-center">Sin productos agregados</p>
                        </div>
                    </div>

                    <hr>

                    <!-- Descuento Global -->
                    <div class="mb-3">
                        <label class="form-label">Descuento Global (S/)</label>
                        <input type="number" class="form-control" id="descuento_global" name="descuento_global"
                               step="0.01" min="0" value="0" oninput="calcularTotalVenta()">
                    </div>

                    <!-- Estado de Pago -->
                    <div class="mb-3">
                        <label class="form-label">Estado de Pago</label>
                        <select class="form-select" id="estado_pago" name="estado_pago">
                            <option value="pagado">Pagado</option>
                            <option value="pendiente">Pendiente</option>
                            <option value="credito">A Crédito</option>
                        </select>
                    </div>

                    <!-- Método de Pago -->
                    <div class="mb-3">
                        <label class="form-label">Método de Pago</label>
                        <select class="form-select" id="metodo_pago" name="metodo_pago">
                            <option value="efectivo">Efectivo</option>
                            <option value="transferencia">Transferencia</option>
                            <option value="tarjeta">Tarjeta</option>
                            <option value="yape">Yape/Plin</option>
                        </select>
                    </div>

                    <!-- Observaciones -->
                    <div class="mb-3">
                        <label class="form-label">Observaciones</label>
                        <textarea class="form-control" id="observaciones" name="observaciones" rows="2"></textarea>
                    </div>

                    <hr>

                    <!-- Totales -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between">
                            <span>Subtotal:</span>
                            <strong id="subtotal">S/ 0.00</strong>
                        </div>
                        <div class="d-flex justify-content-between text-danger">
                            <span>Descuento:</span>
                            <strong id="descuento-texto">S/ 0.00</strong>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between">
                            <h5>Total:</h5>
                            <h5 class="text-primary" id="total">S/ 0.00</h5>
                        </div>
                    </div>

                    <!-- Botones -->
                    <button type="submit" class="btn btn-primary w-100" id="btnGuardar" disabled>
                        <i class="bi bi-save"></i> Registrar Venta
                    </button>
                    <a href="/ventas" class="btn btn-outline-secondary w-100 mt-2">
                        <i class="bi bi-arrow-left"></i> Cancelar
                    </a>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
let inventarioActual = [];
let carrito = []; // Array de productos agregados al carrito

// Función para seleccionar cliente
function seleccionarCliente() {
    const select = document.getElementById('id_cliente');
    const option = select.options[select.selectedIndex];

    if (select.value) {
        const nombreCompleto = option.dataset.nombre;
        document.getElementById('cliente_nombre').value = nombreCompleto;
    } else {
        document.getElementById('cliente_nombre').value = '';
    }
}

function cargarInventario() {
    const ubicacionId = document.getElementById('ubicacion').value;

    if (!ubicacionId) {
        document.getElementById('card-inventario').style.display = 'none';
        return;
    }

    fetch(`/api/inventario/por-ubicacion/${ubicacionId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                inventarioActual = data.inventario;
                mostrarInventario(data.inventario);
                document.getElementById('card-inventario').style.display = 'block';
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            alert('Error al cargar inventario: ' + error);
        });
}

function mostrarInventario(items) {
    const tabla = document.getElementById('tabla-inventario');
    const totalItems = document.getElementById('total-items');

    if (items.length === 0) {
        tabla.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Sin stock disponible en esta ubicación</td></tr>';
        totalItems.textContent = '0 productos disponibles';
        return;
    }

    totalItems.textContent = `${items.length} producto(s) disponible(s)`;

    tabla.innerHTML = items.map(item => `
        <tr>
            <td><strong>${item.codigo_interno}</strong></td>
            <td>
                <small>${item.tipo_calzado}</small><br>
                ${item.cuero} ${item.color_cuero}<br>
                <small class="text-muted">${item.serie_tallas}</small>
            </td>
            <td><strong class="text-success">${item.cantidad_pares}</strong> pares</td>
            <td>S/ ${item.precio_sugerido.toFixed(2)}</td>
            <td>
                <button class="btn btn-sm btn-success" onclick='agregarAlCarrito(${JSON.stringify(item)})'>
                    <i class="bi bi-cart-plus"></i> Agregar
                </button>
            </td>
        </tr>
    `).join('');
}

function agregarAlCarrito(item) {
    // Verificar si el producto ya está en el carrito
    const existe = carrito.find(p => p.id_inventario === item.id_inventario);

    if (existe) {
        alert('Este producto ya está en el carrito. Edita la cantidad desde el carrito.');
        return;
    }

    // Agregar al carrito con cantidad inicial 1
    carrito.push({
        id_inventario: item.id_inventario,
        id_producto: item.id_producto,
        codigo_interno: item.codigo_interno,
        cuero: item.cuero,
        color_cuero: item.color_cuero,
        serie_tallas: item.serie_tallas,
        stock_disponible: item.cantidad_pares,
        cantidad_pares: 1,
        pares_por_docena: item.pares_por_docena || 12,
        precio_unitario: item.precio_sugerido,
        descuento_linea: 0
    });

    actualizarVistaCarrito();
    calcularTotalVenta();
}

function quitarDelCarrito(index) {
    carrito.splice(index, 1);
    actualizarVistaCarrito();
    calcularTotalVenta();
}

function actualizarCantidad(index, nuevaCantidad) {
    const producto = carrito[index];
    nuevaCantidad = parseInt(nuevaCantidad);

    if (nuevaCantidad < 1) {
        nuevaCantidad = 1;
    }

    if (nuevaCantidad > producto.stock_disponible) {
        alert(`Stock insuficiente. Disponible: ${producto.stock_disponible} pares`);
        document.getElementById(`cantidad_${index}`).value = producto.cantidad_pares;
        return;
    }

    carrito[index].cantidad_pares = nuevaCantidad;
    calcularTotalVenta();
}

function actualizarPrecio(index, nuevoPrecio) {
    carrito[index].precio_unitario = parseFloat(nuevoPrecio) || 0;
    calcularTotalVenta();
}

function actualizarVistaCarrito() {
    const lista = document.getElementById('lista-carrito');

    if (carrito.length === 0) {
        lista.innerHTML = '<p class="text-muted small text-center">Sin productos agregados</p>';
        document.getElementById('btnGuardar').disabled = true;
        return;
    }

    document.getElementById('btnGuardar').disabled = false;

    lista.innerHTML = carrito.map((prod, index) => `
        <div class="card mb-2">
            <div class="card-body p-2">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <div>
                        <strong>${prod.codigo_interno}</strong><br>
                        <small class="text-muted">${prod.cuero} ${prod.color_cuero}</small>
                    </div>
                    <button class="btn btn-sm btn-danger" onclick="quitarDelCarrito(${index})">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
                <div class="row g-2">
                    <div class="col-6">
                        <label class="form-label small">Cantidad</label>
                        <input type="number" class="form-control form-control-sm" id="cantidad_${index}"
                               value="${prod.cantidad_pares}" min="1" max="${prod.stock_disponible}"
                               onchange="actualizarCantidad(${index}, this.value)">
                        <small class="text-muted">Max: ${prod.stock_disponible}</small>
                    </div>
                    <div class="col-6">
                        <label class="form-label small">Precio</label>
                        <input type="number" class="form-control form-control-sm"
                               value="${prod.precio_unitario}" step="0.01" min="0"
                               onchange="actualizarPrecio(${index}, this.value)">
                    </div>
                </div>
                <div class="mt-2 text-end">
                    <strong>Subtotal: S/ ${(prod.cantidad_pares * prod.precio_unitario).toFixed(2)}</strong>
                </div>
            </div>
        </div>
    `).join('');
}

function calcularTotalVenta() {
    let subtotalVenta = 0;

    carrito.forEach(prod => {
        subtotalVenta += prod.cantidad_pares * prod.precio_unitario;
    });

    const descuentoGlobal = parseFloat(document.getElementById('descuento_global').value) || 0;
    const totalFinal = subtotalVenta - descuentoGlobal;

    document.getElementById('subtotal').textContent = 'S/ ' + subtotalVenta.toFixed(2);
    document.getElementById('descuento-texto').textContent = 'S/ ' + descuentoGlobal.toFixed(2);
    document.getElementById('total').textContent = 'S/ ' + totalFinal.toFixed(2);
}

document.getElementById('formVenta').addEventListener('submit', function(e) {
    e.preventDefault();

    if (carrito.length === 0) {
        alert('Debe agregar al menos un producto al carrito');
        return;
    }

    const idCliente = document.getElementById('id_cliente').value;
    if (!idCliente) {
        alert('Debe seleccionar un cliente');
        return;
    }

    const formData = {
        id_cliente: parseInt(idCliente),
        cliente: document.getElementById('cliente_nombre').value,
        productos: carrito,
        descuento_global: parseFloat(document.getElementById('descuento_global').value) || 0,
        estado_pago: document.getElementById('estado_pago').value,
        metodo_pago: document.getElementById('metodo_pago').value,
        observaciones: document.getElementById('observaciones').value
    };

    fetch('/api/ventas/registrar-directa', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`✓ Venta registrada exitosamente\nCódigo: ${data.codigo_venta}\nProductos: ${data.total_productos}\nTotal: S/ ${data.total_final.toFixed(2)}`);
            window.location.href = '/ventas';
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        alert('Error al registrar venta: ' + error);
    });
});
</script>

{% endblock %}
