{% extends "base.html" %}
{% block title %}Producci√≥n - Sistema Calzado{% endblock %}
{% block content %}
<div class="page-header d-flex justify-content-between align-items-center">
    <div>
        <h1><i class="bi bi-hammer"></i> Producci√≥n de Calzado</h1>
        <p class="text-muted">Productos materializados a partir de variantes base</p>
    </div>
    <a href="/catalogo-variantes" class="btn btn-outline-secondary">
        <i class="bi bi-box"></i> Ver Cat√°logo
    </a>
</div>

<!-- Ayuda sobre estados -->
<div class="alert alert-info mb-3">
    <strong>‚ÑπÔ∏è Estados de Producci√≥n:</strong>
    <ul class="mb-0 mt-2">
        <li><strong>‚úì Con Stock:</strong> Producto ya ingresado a inventario y disponible</li>
        <li><strong>‚ùå Agotado:</strong> Se vendi√≥ todo el stock (no se puede reingresar, debes producir nuevamente)</li>
        <li><strong>‚è≥ Pendiente Ingreso:</strong> Producto reci√©n producido que a√∫n NO se ha ingresado a ning√∫n inventario/ubicaci√≥n</li>
    </ul>
</div>

<!-- Filtros -->
<div class="card mb-3">
    <div class="card-body">
        <div class="btn-group me-3" role="group">
            <button type="button" class="btn btn-outline-primary active" onclick="filtrarEstado('todos')">
                üì¶ Todos
            </button>
            <button type="button" class="btn btn-outline-success" onclick="filtrarEstado('disponible')">
                ‚úì Con Stock
            </button>
            <button type="button" class="btn btn-outline-danger" onclick="filtrarEstado('agotado')">
                ‚ùå Agotado
            </button>
            <button type="button" class="btn btn-outline-info" onclick="filtrarEstado('pendiente')">
                ‚è≥ Pendiente Ingreso
            </button>
        </div>
        <span id="resultado-filtro">Mostrando todos los productos</span>
    </div>
</div>

<!-- Tabla de productos producidos -->
<div class="card">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0" id="tabla-produccion">
                <thead>
                    <tr>
                        <th>Estado</th>
                        <th>ID</th>
                        <th>C√≥digo Interno</th>
                        <th>Tipo</th>
                        <th>Cuero</th>
                        <th>Color</th>
                        <th>Suela</th>
                        <th>Forro</th>
                        <th>Serie Tallas</th>
                        <th>Producido</th>
                        <th>Ingresado</th>
                        <th>Pendiente</th>
                        <th>Stock Actual</th>
                        <th>Costo</th>
                        <th>Precio</th>
                        <th>Fecha Prod.</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for producto in productos %}
                    {% if producto.tiene_registros_inventario == 0 %}
                        {% set estado = 'pendiente' %}
                    {% elif producto.stock_actual > 0 %}
                        {% set estado = 'disponible' %}
                    {% else %}
                        {% set estado = 'agotado' %}
                    {% endif %}
                    {% set vendido = producto.cantidad_total_pares - producto.stock_actual %}
                    <tr data-estado="{{ estado }}" class="{% if estado == 'agotado' %}table-secondary{% elif estado == 'pendiente' %}table-warning{% endif %}">
                        <td class="text-center">
                            {% if estado == 'agotado' %}
                                <span class="badge bg-danger" title="Totalmente vendido/agotado">‚ùå</span>
                            {% elif estado == 'pendiente' %}
                                <span class="badge bg-warning" title="Pendiente de ingresar a inventario">‚è≥</span>
                            {% else %}
                                <span class="badge bg-success" title="Disponible en inventario">‚úì</span>
                            {% endif %}
                        </td>
                        <td><small class="text-muted">#{{ producto.id_producto }}</small></td>
                        <td><span class="badge bg-primary">{{ producto.codigo_interno }}</span></td>
                        <td><small>{{ producto.tipo_calzado }}</small></td>
                        <td><strong>{{ producto.cuero }}</strong></td>
                        <td>{{ producto.color_cuero }}</td>
                        <td>{{ producto.suela }}</td>
                        <td><small>{{ producto.forro or '-' }}</small></td>
                        <td><small class="text-muted">{{ producto.serie_tallas }}</small></td>
                        <td class="text-center"><strong>{{ producto.cantidad_total_pares }}</strong></td>
                        <td class="text-center">
                            <strong class="text-info">{{ producto.cantidad_ingresada or 0 }}</strong>
                        </td>
                        <td class="text-center">
                            {% if producto.pendiente_ingresar > 0 %}
                                <strong class="text-warning">{{ producto.pendiente_ingresar }}</strong>
                                <br><small class="text-warning">‚è≥ Pendiente</small>
                            {% else %}
                                <span class="text-success">‚úì</span>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            {% if estado == 'agotado' %}
                                <strong class="text-danger">0</strong>
                                <br><small class="text-danger">Vendido: {{ vendido }} pares</small>
                            {% else %}
                                <strong class="text-success">{{ producto.stock_actual }}</strong>
                                {% if vendido > 0 %}
                                    <br><small class="text-muted">Vendido: {{ vendido }}</small>
                                {% endif %}
                            {% endif %}
                        </td>
                        <td>S/ {{ "%.2f"|format(producto.costo_unitario) }}</td>
                        <td><strong>S/ {{ "%.2f"|format(producto.precio_sugerido) }}</strong></td>
                        <td><small>{{ producto.fecha_produccion }}</small></td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="editarProducto({{ producto.id_producto }})" title="Editar">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="eliminarProducto({{ producto.id_producto }})" title="Eliminar">
                                    <i class="bi bi-trash"></i>
                                </button>
                                {% if producto.pendiente_ingresar > 0 %}
                                <a href="/inventario/ingresar/{{ producto.id_producto }}" class="btn btn-outline-warning" title="Ingresar {{ producto.pendiente_ingresar }} pares pendientes">
                                    <i class="bi bi-box-arrow-in-down"></i> {{ producto.pendiente_ingresar }}
                                </a>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    <div class="card-footer text-muted">
        Mostrando: <strong id="contador-visible">{{ productos|length }}</strong> de <strong>{{ productos|length }}</strong> productos
    </div>
</div>

<!-- Modal: Editar Producto -->
<div class="modal fade" id="modalEditarProducto" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-pencil"></i> Editar Producto Producido</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formEditarProducto">
                    <input type="hidden" id="edit_id_producto" name="id_producto">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Cuero *</label>
                            <input type="text" class="form-control" id="edit_cuero" name="cuero" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Color Cuero *</label>
                            <input type="text" class="form-control" id="edit_color_cuero" name="color_cuero" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Suela *</label>
                            <input type="text" class="form-control" id="edit_suela" name="suela" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Forro</label>
                            <input type="text" class="form-control" id="edit_forro" name="forro">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Material Plantilla</label>
                            <input type="text" class="form-control" id="edit_material_plantilla" name="material_plantilla">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Serie de Tallas</label>
                            <input type="text" class="form-control" id="edit_serie_tallas" name="serie_tallas">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Cantidad Total Pares *</label>
                            <input type="number" class="form-control" id="edit_cantidad_total_pares" name="cantidad_total_pares" min="1" required>
                            <small class="text-muted" id="edit_cantidad_info"></small>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Costo Unitario (S/)</label>
                            <input type="number" class="form-control" id="edit_costo_unitario" name="costo_unitario" step="0.01" min="0">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Precio Sugerido (S/)</label>
                            <input type="number" class="form-control" id="edit_precio_sugerido" name="precio_sugerido" step="0.01" min="0">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Fecha Produccion</label>
                            <input type="date" class="form-control" id="edit_fecha_produccion" name="fecha_produccion">
                        </div>
                        <div class="col-12">
                            <label class="form-label">Observaciones</label>
                            <textarea class="form-control" id="edit_observaciones" name="observaciones" rows="2"></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="guardarEdicionProducto()">
                    <i class="bi bi-save"></i> Guardar Cambios
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function filtrarEstado(estado) {
    const filas = document.querySelectorAll('#tabla-produccion tbody tr');
    let contador = 0;

    // Actualizar botones activos
    document.querySelectorAll('.btn-group .btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');

    filas.forEach(row => {
        const estadoRow = row.dataset.estado;
        let mostrar = false;

        if (estado === 'todos') {
            mostrar = true;
        } else if (estado === 'disponible') {
            mostrar = estadoRow === 'disponible';
        } else if (estado === 'agotado') {
            mostrar = estadoRow === 'agotado';
        } else if (estado === 'pendiente') {
            mostrar = estadoRow === 'pendiente';
        }

        if (mostrar) {
            row.style.display = '';
            contador++;
        } else {
            row.style.display = 'none';
        }
    });

    // Actualizar contador y mensaje
    const total = filas.length;
    document.getElementById('contador-visible').textContent = contador;

    const mensajes = {
        'todos': 'Mostrando todos los productos',
        'disponible': 'Mostrando productos con stock disponible',
        'agotado': 'Mostrando productos totalmente vendidos/agotados',
        'pendiente': 'Mostrando productos pendientes de ingresar a inventario'
    };
    document.getElementById('resultado-filtro').textContent = mensajes[estado];
}

function editarProducto(idProducto) {
    fetch(`/api/productos/${idProducto}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const p = data.producto;

                document.getElementById('edit_id_producto').value = p.id_producto;
                document.getElementById('edit_cuero').value = p.cuero || '';
                document.getElementById('edit_color_cuero').value = p.color_cuero || '';
                document.getElementById('edit_suela').value = p.suela || '';
                document.getElementById('edit_forro').value = p.forro || '';
                document.getElementById('edit_material_plantilla').value = p.material_plantilla || '';
                document.getElementById('edit_serie_tallas').value = p.serie_tallas || '';
                document.getElementById('edit_cantidad_total_pares').value = p.cantidad_total_pares;
                document.getElementById('edit_cantidad_total_pares').min = p.cantidad_ingresada || 0;
                document.getElementById('edit_costo_unitario').value = p.costo_unitario || 0;
                document.getElementById('edit_precio_sugerido').value = p.precio_sugerido || 0;
                document.getElementById('edit_fecha_produccion').value = p.fecha_produccion || '';
                document.getElementById('edit_observaciones').value = p.observaciones || '';

                // Mostrar info de cantidad ingresada
                const cantIngresada = p.cantidad_ingresada || 0;
                if (cantIngresada > 0) {
                    document.getElementById('edit_cantidad_info').textContent =
                        `Minimo: ${cantIngresada} (ya ingresados a inventario)`;
                } else {
                    document.getElementById('edit_cantidad_info').textContent = '';
                }

                const modal = new bootstrap.Modal(document.getElementById('modalEditarProducto'));
                modal.show();
            } else {
                alert('Error al cargar producto: ' + data.error);
            }
        })
        .catch(error => alert('Error: ' + error));
}

function guardarEdicionProducto() {
    const form = document.getElementById('formEditarProducto');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);
    const idProducto = data.id_producto;

    fetch(`/api/productos/${idProducto}/editar`, {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => alert('Error: ' + error));
}

function eliminarProducto(idProducto) {
    if (!confirm('¬øEstas seguro de eliminar este producto?\n\nSolo se puede eliminar si NO tiene:\n- Registros en inventario\n- Ventas asociadas')) {
        return;
    }

    fetch(`/api/productos/${idProducto}/eliminar`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => alert('Error: ' + error));
}
</script>

{% endblock %}
